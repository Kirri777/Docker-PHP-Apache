<!DOCTYPE html>
<html>

    <head>
        <title>Test - PHP Push WebSocket</title>
        <meta charset="utf-8" />

        <script type="text/javascript">
            var ws, url = 'ws://192.168.15.210:45900/app';

            /**
             * Connects to a WebSocket server and handles the opening, message, 
             * close and error events
             * @param {string} url - The URL of the WebSocket server
             */
            function connectToWebSocket(url) {
                try {
                    ws = new WebSocket(url);
                    write(`Connecting... (readyState ${ws.readyState})`);

                    // Connection opened event
                    ws.onopen = function () {
                        write(`Connection successfully opened (readyState ${this.readyState})`);
                    };

                    // Message received event
                    ws.onmessage = function (event) {
                        write(`Server says: ${event.data}`);
                    };

                    // Connection closed event
                    ws.onclose = function () {
                        if (this.readyState == 2) {
                            write(`Closing... The connection is going throught the closing handshake (readyState ${this.readyState})`);
                        } else if (this.readyState == 3) {
                            write(`Connection closed... The connection has been closed or could not be opened (readyState ${this.readyState})`);
                        } else {
                            write(`Connection closed... (unhandled readyState ${this.readyState})`);
                        }
                    };

                    // Error event
                    ws.onerror = function (event) {
                        // Write to terminal
                        const terminal = document.getElementById('terminal');
                        terminal.innerHTML = `<li style="color: red;">${event.data}</li>` + terminal.innerHTML;
                    };
                } catch (exception) {
                    write(exception);
                }
            }

            /**
             * Writes the given text to the terminal, along with a timestamp.
             *
             * @param {string} text - The text to write to the terminal.
             */
            function write(text) {
                // Generate timestamp
                const date = new Date();
                const year = date.getFullYear();
                const month = date.getMonth() + 1 > 9 ? date.getMonth() + 1 : '0' + date.getMonth() + 1;
                const day = date.getDate() > 9 ? date.getDate() : '0' + date.getDate();
                const hours = date.getHours() > 9 ? date.getHours() : '0' + date.getHours();
                const minutes = date.getMinutes() > 9 ? date.getMinutes() : '0' + date.getMinutes();
                const seconds = date.getSeconds() > 9 ? date.getSeconds() : '0' + date.getSeconds();
                const dateText = `[${year}-${month}-${day} ${hours}:${minutes}:${seconds}]`;

                // Write to terminal
                const terminal = document.getElementById('terminal');
                terminal.innerHTML = `<li>${dateText} ${text}</li>` + terminal.innerHTML;
            }

            /**
             * Send a message through the WebSocket connection
             */
            function sendMessage() {
                // Define the message object
                const message = {
                    action: "message",
                    method: "TestWebSocket",
                    data: "Hello World!",
                    id: "clientID",
                    date: Date.now()
                };

                // Convert the message object to a JSON string and send it through the WebSocket connection
                ws.send(JSON.stringify(message));
            }
        </script>

    </head>

    <body>
        <button onclick="sendMessage()">Send</button>
        <a href="test.html" target="_blank">Add another client</a>
        <ul id="terminal"></ul>

        <script type="text/javascript">
            connectToWebSocket(url);
        </script>
    </body>

</html>